---
title: "COVID risk data source comparison"
output:
  html_document:
    df_print: paged
    fig_width: 8 
    fig_height: 6 
---

```{r setup, include = F}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = F) #, fig.width=12, fig.height=8

library(readxl)
library(tidyverse)
library(lubridate)
library(reportfactory)
library(data.table)
library(zoo)
library(dtplyr)
library(mgcv)
library(tidymv)
theme_set(theme_minimal())

# MSOA lookups:
chdir <- "C:/Users/phpuenig/Dropbox/Carehomes/"
msoa_pc <- fread(paste0(chdir,"admin_geography/pc_to_msoa.csv"))
msoa_pc[, postcode := tolower(gsub(" ","",pcds))]
msoa_pop <- fread(paste0(chdir,"admin_geography/msoa_pop.csv"))
msoa_ltla <- fread(paste0(chdir,"admin_geography/msoa_to_ltla.csv"))
msoa_nb <- fread(paste0(chdir,"admin_geography/msoa_neighbours_full.csv"))

datadir <- "C:/Users/phpuenig/Documents/COVID-19/Data/"

# STP lookup
stp_lookup <- read.csv(paste0(datadir,"ccg_stp_region_lookup.csv")) %>%
  dplyr::select(-1:-4) %>%
  unique() 
lad_lookup <- read.csv(paste0(datadir,"lad_region_lookup.csv")) %>%
  rename_all(tolower)

# Population estimates
pops_reg <- read.csv(paste0(datadir,"region_stats.csv"))

pops_msoa_ltla <- read_xlsx(paste0(datadir,"msoa_pops.xlsx"), 
                       sheet = "Mid-2018 Persons",
                       skip = 4) %>%
  rename_all(function(x) tolower(gsub(" ","_",x))) %>%
  dplyr::select(1:4) %>%
  rename(lad19nm = `la_(2019_boundaries)`) %>%
  mutate(ladnm_alt = lad19nm,
         ladcd_alt = area_codes)

pops_msoa_ltla$ladnm_alt[pops_msoa_ltla$lad19nm %in% c("South Bucks","Chiltern","Aylesbury Vale","Wycombe")] <- "Buckinghamshire"
pops_msoa_ltla$ladcd_alt[pops_msoa_ltla$lad19nm %in% c("South Bucks","Chiltern","Aylesbury Vale","Wycombe")] <- "E06000060"
pops_msoa_ltla$ladnm_alt[pops_msoa_ltla$lad19nm == "Basingstoke and Dean"] <- "Basingstoke and Deane"

# Fix LTLA matching
msoa_ltla[,ltla_code := LTLA17CD]
msoa_ltla[LTLA17CD %in% c("E06000028","E07000048","E06000029"), ltla_code := "E06000058"] # Bournemouth, Christchurch and Poole
msoa_ltla[grepl("Dorset", LTLA17NM)| LTLA17NM %in% c("Purbeck","Weymouth and Portland"), ltla_code := "E06000059"] # East/West/North Dorset
msoa_ltla[LTLA17NM %in% c("St Edmundsbury","Forest Heath"), ltla_code := "E07000245"] # West suffolk
msoa_ltla[LTLA17NM %in% c("Suffolk Coastal","Waveney"), ltla_code := "E07000244"] # East suffolk
msoa_ltla[LTLA17NM %in% c("Taunton Deane","West Somerset"), ltla_code := "E07000246"] # East suffolk
# Isles of Scilly excluded - no cases/calls

regions <- readRDS(paste0(datadir,"Deaths/maps/LA_shp_wpops.rds"))

```


```{r load_data, message = FALSE}
# Access data pipeline
path_to_factory <- "C:/Users/phpuenig/Documents/COVID-19/covid19_automation"
setwd(path_to_factory)
rfh_load_scripts()

## --- NHS pathways data --- ##

calls_raw <- import_clear_pathways() 
# %>%
#   data.table() %>%
#   lazy_dt() 

calls_raw %>%
  filter(!is.na(postcode) & grepl("111", site_type)) %>%
  group_by(date, ccg_code, ccg_name, nhs_region, postcode) %>%
  summarise(count = sum(count)) %>%
  mutate(pc_area = case_when(str_length(postcode) == 5 ~ toupper(substr(postcode,1,2)),
                             str_length(postcode) == 6 ~ toupper(substr(postcode,1,3)),
                             str_length(postcode) == 7 ~ toupper(substr(postcode,1,4))),
         pc_region = gsub("[0-9]+", "", pc_area)) %>%
  left_join(msoa_pc) %>%
  left_join(pops_msoa_ltla[!is.na(pops_msoa_ltla$msoa),c(1,3,4)], by = c("msoa11cd" = "area_codes")) %>% #add pop estimates
  mutate(count = replace_na(count, 0)) %>%
  group_by(msoa11cd) %>%
  mutate(peak = date[which.max(count)]) %>% 
  ungroup() -> calls_pc

date_range <- range(calls_pc$date)

# calculate totals and rolling average by MSOA
calls <- calls_pc %>%
  group_by(date, msoa11cd, msoa11nm, nhs_region, all_ages) %>% 
  summarise(count = base::sum(count, na.rm = T),
            peak = unique(peak)) %>%
  group_by(msoa11cd, msoa11nm, nhs_region, all_ages, peak) %>% 
  tidyr::complete(date = seq.Date(date_range[1], date_range[2], by = "day"), fill = list(count = 0)) %>%
  mutate(rate = count/all_ages,
         rollavg7 = rollmean(rate, 7, fill = NA, align = "right")) %>%
  ungroup() %>%
  arrange(msoa11cd, date)

# # Overall date range
# date_range <- range(calls$date)
# # Replicate per region
# all_dates <- callsDT[,.(date=seq(date_range[1],date_range[2],"days")),by = c("msoa11cd", "msoa11nm", "nhs_region", "all_ages")]
# 
# # Merge and fill count with 0
# setkey(callsDT,msoa11cd, date)
# setkey(all_dates, msoa11cd, date)
# callsDT[all_dates,roll=FALSE]
# callsDT[is.na(count), count:=0]
# 
# setkey(calls, "msoa11cd", "date")
# calls[, rollavg7 := rollmean(rate, 7, fill = NA, align = "right"), by = msoa11cd]
# summary(calls$rollavg7)
# 
# calls <- lazy_dt(calls)
# 
# date_range <- seq.Date(range(pull(calls,date)), by = "day")
# 
# calls <- calls %>% 
#   group_by(msoa11cd) %>%
#   complete(date = seq.Date(date_range[1],date_range[2], by="day")) %>%
#   as.data.table()

## --- Linelist of confirmed cases (P1&2) --- ##

# Only available to LTLA level
ll_raw <- import_linelist() %>%
  filter(date_lab_report > "2020-01-01")

date_range <- range(ll_raw$date_lab_report, na.rm = T)
ll_raw %>%
  filter(ltla_code != "missing") %>%
  mutate(ltla_code = toupper(ltla_code)) %>%
  group_by(nhser_name, ltla_code, date_lab_report) %>%
  count() %>% 
  left_join(pops_msoa_ltla[!is.na(pops_msoa_ltla$lad19nm),c(1,2,4)], by = c("ltla_code" = "area_codes")) %>% #add pop estimates
  group_by(nhser_name, ltla_code, all_ages) %>% 
  tidyr::complete(date_lab_report = seq.Date(date_range[1], date_range[2], by = "day"), fill = list(n = 0)) %>%
  mutate(rate = n/all_ages,
         rollavg7 = rollmean(rate, 7, fill = NA, align = "right")) -> cases

## --- ONS deaths --- ##
deaths_raw <- readRDS("C:/Users/phpuenig/Documents/COVID-19/Data/Deaths/alldata.rds") 

deaths_raw %>%
  group_by(lad19cd) %>%
  mutate(first = (dod == min(dod)), date_first = min(dod)) %>%
  group_by(lad19cd, pod2) %>%
  mutate(first_pod = (dod == min(dod)), 
         date_first_pod = min(dod),
         population := trimws(sub("NHS England ","",sub("\\(.*","",nhsrlo19nm)))) %>%
  ungroup() -> deaths_all

date_range <- range(deaths_all$dod, na.rm = T)
pops_ltla_alt <- pops_msoa_ltla %>%
  group_by(ladcd_alt, ladnm_alt) %>%
  summarise(all_ages = sum(all_ages)) %>%
  filter(!is.na(ladnm_alt)) 
deaths_all %>% 
  group_by(dod, lad19cd, lad19nm, population) %>%
  summarise(deaths = sum(deaths)) %>% 
  left_join(pops_ltla_alt, by = c("lad19cd" = "ladcd_alt", "lad19nm" = "ladnm_alt")) %>% #add pop estimates
  group_by(lad19cd, lad19nm, population, all_ages) %>% 
  tidyr::complete(dod = seq.Date(date_range[1], date_range[2], by = "day"), fill = list(deaths = 0)) %>%
  mutate(rate = deaths/all_ages,
         rollavg7 = rollmean(rate, 7, fill = NA, align = "right")) -> deaths

## --- model predictions --- ##

model_preds <- readRDS("C:/Users/phpuenig/Dropbox/COVID-19/care homes/roz_foi-2020-07-10.rds") %>%
  filter(!population %in% c("Scotland","Wales","Northern Ireland")) %>%
  mutate(age_group = case_when(group %in% 1:2 ~ "[0,10)",
                               group %in% 3:4 ~ "[10,20)",
                               group %in% 5:6 ~ "[20,30)",
                               group %in% 7:8 ~ "[30,40)",
                               group %in% 9:10 ~ "[40,50)",
                               group %in% 11:12 ~ "[50,60)",
                               group %in% 13:14 ~ "[60,70)",
                               group %in% 15:16 ~ "[70,80)")) 

## --- opensafely --- ##

os_tot <- read.csv("C:/Users/phpuenig/Documents/COVID-19/carehomes-research/data/total_patient_counts_by_stp.csv") %>%
  rename(stp = X, total_patients = stp) %>%
  filter(stp != "") %>% 
  left_join(stp_lookup,  by = c("stp" = "STP20CD"))
os <- read.csv("C:/Users/phpuenig/Documents/COVID-19/carehomes-research/data/event_counts_by_stp.csv") %>%
  full_join(os_tot) %>% 
  filter(stp != "") %>% 
  mutate(date = lubridate::ymd(X)) %>% #View()
  # left_join(stp_lookup, by = c("stp" = "STP20CD")) %>% View()
  group_by(NHSER20CD, date) %>%
  mutate(total_patients_region = sum(total_patients)) %>%
  ungroup()

## --- Zoe --- ##

dir <- "C:/Users/phpuenig/Filr/Net Folders/EPH Shared/covid/Zoe/"
zfiles <- list.files(dir, ".rds")
zoe_inc <- readRDS(paste0(dir,zfiles[grep("inc",zfiles)]))
zoe_prev <- readRDS(paste0(dir,zfiles[grep("prev",zfiles)])) %>%
  filter(grepl("E",lad16cd)) %>% # remove wales and scotland
  left_join(lad_lookup) %>%
  mutate(NHSER20NM = as.character(rgn16nm))
zoe_prev$NHSER20NM[zoe_prev$NHSER20NM %in% c("North East","Yorkshire and The Humber")] <- "North East and Yorkshire"
zoe_prev$NHSER20NM[zoe_prev$NHSER20NM %in% c("East Midlands","West Midlands")] <- "Midlands"

zoe_prev %>%
  group_by(NHSER20NM,date) %>%
  summarise(population = sum(population),
            active_cases = sum(active_cases)) -> zoe_prev_agg


outbreaks_raw <- read_xlsx(paste0(datadir,"Care_home_outbreaks_of_COVID-19_Management_Information.xlsx"), 
                       sheet = "Lower_Tier_Local_authorities",
                       skip = 1) %>%
  rename_all(function(x) tolower(gsub(" ","_",x))) 
names(outbreaks_raw)[1:3] <- c("lad19nm","lad19cd","nhs_region")
dates <- grep("2020",names(outbreaks_raw))
date_range <- range(as.Date(names(outbreaks_raw)[dates]))

outbreaks <- outbreaks_raw %>%
  pivot_longer(cols = dates, values_to = "n", names_to = "date") %>%
  mutate(date = as.Date(date),
         number_of_care_homes = as.numeric(replace_na(number_of_care_homes,0))) %>% 
  group_by(lad19nm, lad19cd, nhs_region, number_of_care_homes,all_outbreaks) %>%
  # tidyr::complete(date = seq.Date(date_range[1], date_range[2], by = "day"), fill = list(n = 0)) %>%
  mutate(cumsum = cumsum(n),
         n_at_risk = number_of_care_homes - cumsum,
         rate = n/number_of_care_homes,
         rate_atrisk = n/n_at_risk)
```

### Data sources:
* NHS 111 queries with suspect covid disposition
  Resolution: Postcode
* Primary care - confirmed and suspect cases
  STP
* UK linelist - confirmed cases
  LTLA
* A&E attendances (currently total only, not covid specific)
  STP
* ONS covid-related deaths (mentioned or underlying)
  LTLA
* Model-predicted cases
  NHS region
* Zoe symptom tracker
  LTLA

Proxy outcome: No. reported outbreaks in care homes per day/LTLA.
  
## 111 calls/online reports

```{r calls}

calls_avg <- calls %>%
  group_by(date) %>% 
  summarise(rate = mean(rate)) %>%
  as.data.frame()

calls %>%
  group_by(date) %>%
  summarise(n = sum(count)) %>%
  mutate(metric = "111") -> calls_bytime
  
msoa_samp <- sample(calls$msoa11cd,10)

## Plot 111 calls by MSOA ##
calls %>% 
  # filter(msoa11cd %in% msoa_samp) %>%
ggplot(aes(date, rate)) +
  geom_line(aes(group = msoa11nm), alpha = 0.2) +
  guides(col = F) +
  geom_line(data = calls_avg, col = "white",lwd = 1.2) +
  labs(x = "Date",y = "N", title = "Rate of 111 calls/online with covid disposition, by MSOA", subtitle = "Daily mean in white") +
  theme_minimal()

## Rolling average 
calls %>% 
ggplot(aes(date, rollavg7)) +
  geom_line(aes(group = msoa11nm), alpha  = 0.2) +
  # geom_line(data = calls_avg, col = "white",lwd = 1.2) +
  labs(x = "Date",y = "", title = "Rate of 111 calls/online with covid disposition, by MSOA", subtitle = "7 day rolling mean") +
  theme_minimal()

## Weird second group? 
calls %>%
  group_by(msoa11cd) %>%
  mutate(peak_avg = date[which.max(rollavg7)]) %>% #View()
  filter(peak_avg > "2020-04-01") %>%
  pull(msoa11nm) %>%
  unique() -> peak2

calls %>% 
  filter(msoa11nm %in% peak2) %>%
ggplot(aes(date, rollavg7)) +
  geom_line(aes(col = msoa11nm)) +
  labs(x = "Date",y = "", title = "MSOAs with simultaneous spike in calls on 06/04", subtitle = "7 day rolling mean") +
  theme_minimal()

# Group which drop after March?
calls %>%
  group_by(msoa11nm) %>%
  filter(date >= "2020-04-01") %>%
  summarise(count = sum(count)) %>%
  filter(count == 0) %>%
  pull(msoa11nm) -> dropmarch


calls %>% 
  filter(msoa11nm %in% dropmarch) %>%
ggplot(aes(date, rollavg7)) +
  geom_line(aes(col = msoa11nm)) +
  labs(x = "Date",y = "", title = "MSOAs which drop to 0 calls beyond 31/03", subtitle = "7 day rolling mean") +
  guides(col = F) +
  theme_minimal()


## Date of peak calls by MSOA ##
# calls %>% 
#   group_by(msoa11cd) %>% 
#   summarise(peak = unique(peak)) %>%
#   as.data.frame() %>%
# ggplot(aes(x = peak)) +
#   geom_bar() + 
#   theme_minimal() +
#   labs(x = "Date of peak calls", y = "Freq", title = "Peak 111 calls/online by MSOA")

```

Subset of MSOAs which all spike on 06/04 for rolling mean (n = `r length(peak2)`) - maybe data missing for first few weeks? Appear randomly distributed, not within a particular area. Also another subgroup for which data stop at end of March (n = `r length(dropmarch)`).


## UK Linelist (confirmed cases, pillar 1+2)

```{r ll}

ll_ts_ltla <- cases %>% 
  group_by(date_lab_report, ltla_code, all_ages) %>% 
  summarise(n = base::sum(n, na.rm = T)) %>% 
  mutate(rate1e5 = n*1e5/all_ages) %>%
  as.data.frame()

ll_ts <- cases %>% 
  group_by(date_lab_report) %>% 
  summarise(n = base::sum(n, na.rm = T)) %>%  
  mutate(date = date_lab_report, metric = "Confirmed cases") %>%
  as.data.frame()


ll_avg <- ll_ts_ltla %>% 
  group_by(date_lab_report) %>% 
  summarise(n = base::mean(n, na.rm = T),
            rate1e5 = base::mean(rate1e5, na.rm = T)) 

ll_ts_ltla %>% 
  ggplot(aes(date_lab_report, rate1e5)) +
  geom_line(aes(group = ltla_code), alpha = 0.1) +
  geom_line(data = ll_avg, col = "white",lwd = 1.2) +
  labs(x = "Date",y = "N", title = "Daily confirmed cases per 100,000 by LTLA (P1&2)") +
  theme_minimal()

cases %>% 
  group_by(lad19nm) %>%
  mutate(rollavg7_n = rollmean(n, 7, fill = NA)) %>%
  ggplot(aes(date_lab_report, rollavg7_n)) +
  geom_line(aes(group = ltla_code), alpha = 0.2) +
  labs(x = "Date",y = "", title = "Confirmed cases  by LTLA (P1&2)", subtitle= "7-day rolling average") +
  theme_minimal()

cases %>% 
  ggplot(aes(date_lab_report, rollavg7*1e5)) +
  geom_line(aes(group = ltla_code), alpha = 0.2) +
  labs(x = "Date",y = "", title = "Confirmed cases per 100,000 by LTLA (P1&2)", subtitle= "7-day rolling average") +
  theme_minimal()

# Outlying series
ll_ts_ltla %>% 
  filter(date_lab_report == "2020-06-28") %>% 
  arrange(-n) %>% 
  slice(1:2) %>% 
  inner_join(lad_lookup, by = c("ltla_code" = "lad16cd")) %>%
  pull(lad16nm) -> outliers
```

Two outlying series in absolute counts are **`r outliers[1]`** and **`r outliers[2]`**. 

## ONS Covid-related deaths

Including cases with covid recorded as an underlying cause of death or mentioned on death certificate.

```{r deaths}

deaths_all %>%
  filter(pod2 == "Care home") %>%
  group_by(dod) %>%
  summarise(deaths = sum(deaths)) -> deaths_ch

deaths %>%
  group_by(dod) %>%
  summarise(deaths = sum(deaths)) -> deaths_bytime

deaths %>% 
  group_by(dod) %>%
  summarise(deaths = base::mean(deaths, na.rm = T)) -> deaths_avg 

deaths %>% 
  ggplot(aes(dod, deaths)) +
  geom_line(aes(group = lad19cd), alpha = 0.2) +
  geom_line(data = deaths_avg, col = "white",lwd = 1.2) +
  labs(x = "Date",y = "N", title = "Covid-related deaths by LTLA") +
  theme_minimal()


deaths %>% 
  ggplot(aes(dod, rollavg7*1e5)) +
  geom_line(aes(group = lad19cd), alpha = 0.2) +
  labs(x = "Date",y = "", title = "Covid-related deaths per 100,000 by LTLA", subtitle= "7-day rolling average") +
  theme_minimal()

```

## Compare 111/linelist/deaths

In total over England.

```{r calls_cases_deaths}

## Compare calls/cases/deaths time series ##
ggplot() +
  geom_line(data = calls_bytime, aes(date, n, col = "111 calls")) +
  geom_line(data = ll_ts, aes(date, n*30, col = "Cases")) + # 6 week lag between calls and confirmed cases (45 days)
  geom_line(data = deaths_bytime, aes(dod, deaths*30, col = "Deaths")) + # 6 week lag between calls and confirmed cases (45 days)
  scale_y_continuous(sec.axis = sec_axis(~./30, name = "Confirmed cases / deaths")) +
  # geom_line(data = deaths_bytime, aes(dod, deaths, col = "Deaths")) +
  labs(x = "Date", y = "111 calls", col = "") +
  theme_minimal() +
  theme(legend.position = c(0.9,0.8)) 
```

## Model-predicted cases

From big transmission model - available by NHS region and 5-year age bands. Originally fitted to death data. Don't include care homes. 

```{r model_preds}

model_preds %>%
  as.data.frame() %>%
  group_by(date, population) %>%
  summarise(pred_cases = sum(cases)) -> pred_agg

pred_agg %>%
  ggplot(aes(date, pred_cases, col = population)) + 
  geom_line() + 
  theme_minimal()

```

### Compare to ONS deaths by NHS region:

```{r model_deaths}

deaths %>%
  group_by(dod, population) %>%
  summarise(n = sum(deaths)) %>%
  rename(date = dod) -> deaths_agg

deaths_merge <- merge(deaths_agg,pred_agg) %>% 
  group_by(population)%>%
  mutate(deaths_rollavg=rollmean(n,7,align='right',fill=NA)) %>% 
  pivot_longer(cols = c("pred_cases","deaths_rollavg")) 


ggplot() +
  geom_line(data = filter(deaths_merge, name == "pred_cases"), aes(x = date,y = value, lty = "Model-predicted cases")) +
  geom_line(data = filter(deaths_merge, name == "deaths_rollavg"), aes(x = date, y = value*40, lty = "Observed deaths\n(7-day rolling mean)")) + 
  scale_y_continuous(sec.axis = sec_axis(~./40, name = "Deaths")) +
  # geom_line(data = deaths_bytime, aes(dod, deaths, col = "Deaths")) +
  labs(x = "Date", y = "Cases", col = "") +
  facet_wrap(~population, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = c(0.9,0.1)) 


```

Approx 3 week lag between predicted case peak and death peak.

### Compare to 111 calls by NHS region:

```{r model_calls}

calls %>%
  group_by(date, nhs_region) %>%
  summarise(calls = sum(count),
            all_ages = sum(all_ages)) %>%
  arrange(nhs_region,date) %>% 
  group_by(nhs_region)%>%
  mutate(calls_rollavg=rollmean(calls,7,align='right',fill=NA)) -> calls_agg

pred_agg %>%
  mutate(nhs_region = tolower(gsub(" ","_",population))) %>%
  full_join(calls_agg) %>%
  pivot_longer(cols = c("pred_cases","calls_rollavg")) -> calls_merge

ggplot() +
  geom_line(data = filter(calls_merge, name == "pred_cases"), aes(x = date,y = value, lty = "Model-predicted cases")) +
  geom_line(data = filter(calls_merge, name == "calls_rollavg"), aes(x = date, y = value/3, lty = "Observed 111 calls\n(7-day rolling mean)")) + 
  scale_y_continuous(sec.axis = sec_axis(~.*3, name = "Calls")) +
  labs(x = "Date", y = "Cases", col = "") +
  facet_wrap(~nhs_region, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = c(0.9,0.1)) 

```

Peak in calls appears to occur just slightly before predicted peak in cases (1-2 weeks?), but data don't capture much of the peak and will be influenced by implementation of lockdown.

### Compare to confirmed cases from UK LL:

```{r model_cases}

cases %>%
  group_by(date_lab_report, nhser_name) %>%
  summarise(cases = sum(n)) %>%
  arrange(nhser_name,date_lab_report) %>% 
  group_by(nhser_name)%>%
  mutate(cases_rollavg=rollapply(cases,7,mean,align='right',fill=NA)) %>%
  as.data.frame() -> cases_agg

pred_agg %>%
  mutate(nhs_region = tolower(gsub(" ","_",population))) %>%
  full_join(cases_agg, by = c("nhs_region" = "nhser_name", "date" = "date_lab_report")) %>%
  pivot_longer(cols = c("pred_cases","cases_rollavg")) -> cases_merge

ggplot() +
  geom_line(data = filter(cases_merge, name == "pred_cases"), aes(x = date,y = value, lty = "Model-predicted cases")) +
  geom_line(data = filter(cases_merge, name == "cases_rollavg"), aes(x = date, y = value*5, lty = "Confirmed cases by testing\n(7-day rolling mean)")) + 
  scale_y_continuous(sec.axis = sec_axis(~./5, name = "Test positives")) +
  labs(x = "Date", y = "Predicted cases", col = "") +
  facet_wrap(~nhs_region, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = c(0.9,0.1)) 


```

Approx 4 week lag. Model predicts cases at point of infection but UKLL recorded by date of lab report, so lag could be related to symptom onset/testing delay.

## Opensafely EHR data 

* Coverage of GPs registered under TPP - ~50% population but distributed unevenly across country. 
* A&E data reflect total attendances and only available up to 17/04.
* Death data include covid-mentioned? 

```{r os_data, fig.width=10}

os %>%
  pivot_longer(cols = 2:6) %>% #stp
  group_by(date,NHSER20NM,name) %>%
  summarise(value = sum(value, na.rm = T),
            total_patients = sum(total_patients)) %>%
  group_by(NHSER20NM,name) %>%
  mutate(rate1e5 = value*1e5/total_patients,
         value_roll = rollmean(value,7,align='right',fill=NA),
         rate_roll = rollmean(rate1e5,7,align='right',fill=NA)) %>%
  filter(!is.na(NHSER20NM)) -> os_region

os_region %>%  #View()
  ggplot(aes(date, rate_roll)) +
  geom_line(aes(group = NHSER20NM, col = NHSER20NM)) + 
  facet_wrap(~name, scales = "free") +
  theme(legend.position = c(0.9,0.1)) +
  labs(y = "Rate per 100,000",title = "Event rate per 100,000 - 7 day rolling mean")


```

What are the block spikes? E.g. primary care cases beginning of May. Just an artifact of rolling mean being influenced by high values? 

### Compare with model predictions: 

```{r model_os, fig.width = 10}

model_preds %>%
  ungroup() %>%
  mutate(nhs_region = tolower(gsub(" ","_",population))) %>%
  group_by(date, nhs_region, population) %>%
  summarise(cases = sum(cases)) %>%
  as.data.frame() -> model_preds_region

os_region %>%
  full_join(model_preds_region, by = c("NHSER20NM" = "population", "date" = "date")) %>%
  filter(name == "primary_care_case") %>% 
  as.data.frame() %>%
  ggplot(aes(date, cases), lwd = 1.1) +
  geom_line(aes(lty = "Model predicted cases")) +
  geom_line(aes(date, value_roll*15,lty = "Primary care cases\n(7-day rolling mean)"),lwd = 1) +
  scale_y_continuous(sec.axis = sec_axis(~./15, name = "Primary care cases")) +
  labs(y = "Predicted cases", title = "Primary care cases") +
  # guides(col = F) +
  facet_wrap(~NHSER20NM, scales = "free") +
  theme(legend.position = c(0.9,0.1)) 

os_region %>%
  full_join(model_preds_region, by = c("NHSER20NM" = "population", "date" = "date")) %>%
  filter(name == "primary_care_suspect_case") %>% 
  as.data.frame() %>%
  ggplot(aes(date, cases), lwd = 1.1) +
  geom_line(aes(lty = "Model predicted cases")) +
  geom_line(aes(date, value_roll,lty = "Suspect cases\n(7-day rolling mean)"),lwd = 1) +
  # scale_y_continuous(sec.axis = sec_axis(~.*4, name = "Model preds")) +
  labs(y = "Predicted cases", title = "Primary care suspect cases") +
  # guides(col = F) +
  facet_wrap(~NHSER20NM, scales = "free") +
  theme(legend.position = c(0.9,0.1))

```

### Compare with calls:

```{r calls_os, fig.width=10}

os_region %>%
  mutate(nhs_region = tolower(gsub(" ","_", NHSER20NM))) %>%
  filter(name == "primary_care_suspect_case") %>%
  as.data.frame() %>% # View()
  ggplot(aes(date, value_roll)) +
  geom_line(aes(lty = "Suspect cases\n(7-day rolling mean)")) +
  geom_line(data = calls_agg, aes(date, calls_rollavg/3,lty = "111 calls\n(7-day rolling mean)")) +
  scale_y_continuous(sec.axis = sec_axis(~.*3, name = "111 calls")) +
  labs(y = "Suspect cases") +
  # guides(col = F) +
  facet_wrap(~nhs_region, scales = "free") +
  theme(legend.position = c(0.9,0.1)) 

```

### Compare two death sources

Highlights the coverage of TPP.
Second possible source of difference in that the covid death indicator in OS may include only cases with covid as underlying cause of death.

```{r os_deaths, fig.width=10}

os_region %>%
  filter(!is.na(NHSER20NM) &  name == "ons_covid_death_date") %>%
  rename(indicator = name, ind_count = value) %>%
  full_join(
    filter(deaths_merge, name == "deaths_rollavg"),
    by = c("NHSER20NM" = "population", "date" = "date")) %>%
  as.data.frame() %>% #View()
  ggplot(aes(date, value_roll, lty = "Opensafely")) +
  geom_line() +
  geom_line(aes(date, value, lty = "ONS covid-related")) +
  # guides(col = F) +
  facet_wrap(~NHSER20NM, scales = "free") +
  theme(legend.position = c(0.9,0.1)) 

```

## Zoe symptom tracker data

Estimated incidence of newly symptomatic and prevalence of ongoing cases scaled up to population level from number of responding users.

```{r zoe}
zoe_prev_avg <- zoe_prev %>%
  group_by(date) %>% 
  summarise(active_cases = mean(active_cases)) 

zoe_inc %>%
  filter(region != "UK") %>%
  ggplot(aes(date,mil_mid, group  = region)) +
  geom_ribbon(aes(ymin = mil_low, ymax = mil_up), alpha = 0.5) +
  geom_line() + 
  facet_wrap(~region, scales = "free") +
  scale_x_date() +
  labs(title = "Estimated newly-symptomatic cases per day, per million", y = "Daily incidence") +
  theme_minimal()

ggplot(zoe_prev, aes(date, active_cases)) +
  geom_line(aes(group  = lad16nm), alpha = 0.2) + 
  geom_line(data = zoe_prev_avg, lwd = 1.2, col = "white") +
  scale_x_date() +
  labs(title = "Estimated active cases by LTLA, per million", y = "Daily prevalence") +
  theme_minimal()

ggplot(zoe_prev_agg, aes(date, active_cases)) +
  geom_line() + 
  facet_wrap(~NHSER20NM, scales = "free") +
  scale_x_date() +
  labs(title = "Estimated active cases per day, per million", y = "Daily prevalence") +
  theme_minimal()

```

## Reported care home outbreaks

West midlands and Yorkshire peaked slighly later. 

```{r ch_ob}

outbreaks %>%
  group_by(nhs_region, date) %>%
  summarise(n = sum(n)) %>%
  ggplot() +
  geom_col(aes(date, n, fill = nhs_region), position = "stack") 

outbreaks %>%
  inner_join(zoe_inc, by = c("nhs_region" = "region","date" = "date")) %>%
  ggplot(aes(x = date)) +
  geom_col(aes(y = n), fill = "steelblue") + 
  geom_ribbon(aes(ymin = mil_low/10, ymax = mil_up/10), alpha = 0.6, fill = "grey") +
  geom_line(aes(y = mil_mid/10), col = "red") + 
  facet_wrap(~nhs_region, scales = "free") +
  scale_y_continuous(sec.axis = sec_axis(~.*10, name = "Zoe incidence")) + 
  labs(title = "Reported care home outbreaks and Zoe-estimated incidence (red)")


outbreaks %>%
  inner_join(filter(calls_merge,name == "calls_rollavg"), by = c("nhs_region" = "population","date" = "date")) %>% 
  ggplot(aes(x = date)) +
  geom_col(aes(y = n), fill = "steelblue") + 
  geom_line(aes(y = value/100), col = "red", lwd = 1.2) + 
  facet_wrap(~nhs_region, scales = "free") +
  scale_y_continuous(sec.axis = sec_axis(~.*100, name = "111 Calls")) + 
  labs(title = "Reported care home outbreaks and 111 calls (red)", y = "Outbreaks")

outbreaks %>%
  inner_join(filter(os_region,name == "primary_care_case"), by = c("nhs_region" = "NHSER20NM","date" = "date")) %>% 
  ggplot(aes(x = date)) +
  geom_col(aes(y = n), fill = "steelblue") + 
  geom_line(aes(y = rate_roll*20), col = "red", lwd = 1.2) + 
  facet_wrap(~nhs_region, scales = "free") +
  scale_y_continuous(sec.axis = sec_axis(~./20, name = "Case rate")) +
  labs(title = "Reported care home outbreaks and primary care cases (red)", y = "Outbreaks")

outbreaks %>%
  inner_join(filter(os_region,name == "primary_care_suspect_case"), by = c("nhs_region" = "NHSER20NM","date" = "date")) %>%
  ggplot(aes(x = date)) +
  geom_col(aes(y = n), fill = "steelblue") + 
  geom_line(aes(y = rate_roll*3), col = "red", lwd = 1.2) + 
  facet_wrap(~nhs_region, scales = "free") +
  scale_y_continuous(sec.axis = sec_axis(~./3, name = "Suspect case rate")) +
  labs(title = "Reported care home outbreaks and primary care suspect cases (red)", y = "Outbreaks")

```

```{r lag}

outbreaks %>%
  inner_join(filter(os_region,name == "primary_care_case"), by = c("nhs_region" = "NHSER20NM","date" = "date")) %>% 
  rename(value_roll_case = value_roll,
         rate_roll_case = rate_roll) %>%
  inner_join(filter(os_region,name == "primary_care_suspect_case"), by = c("nhs_region" = "NHSER20NM","date" = "date")) %>%
  rename(value_roll_suspect = value_roll,
         rate_roll_suspect = rate_roll) -> outbreaks_os

corlag<- vector()
for (l in 1:14){
  d <- outbreaks_os %>%
       mutate(rate_roll_suspect_lag = lag(rate_roll_suspect,l)) 
  c <- stats::cor(d$n, d$rate_roll_suspect_lag, method = "pearson",use = "complete.obs")
  print(c)
  corlag[l] <- c
}
ggplot(data.frame(l = 1:14,cor = corlag),aes(l,cor)) + geom_point() + geom_hline(aes(yintercept = 0),col = "red", lty = "dashed") + theme_minimal()

```

```{r ob_zoe_ltla}
# 
# ltla_samp <- sample(outbreaks$lad19nm,9)
# outbreaks %>%
#   inner_join(os, by = c("lad19cd" = "lad16cd","lad19nm" = "lad16nm", "date" = "date")) %>% #View()
#   filter(lad19nm %in% ltla_samp) %>%
#   # mutate(n = gsub(0,NA,n)) %>%
#   ggplot() +
#   geom_col(aes(date,n), fill = "steelblue") + #, position = "jitter", alpha = 0.2, sides = "b"
#   geom_line(aes(date, active_cases/10)) +
#   scale_y_continuous(sec.axis = sec_axis(~.*10, name = "Active cases")) +
#   facet_wrap(~lad19nm, scales = "free")

```